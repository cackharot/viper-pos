{% extends "templates/layout.jinja2" %}
{% block content %}
<section id="manage-products">
	 <div class="page-header">
       <h1> {{ 'Add Purchase' if not model.Id }}
	        {{ 'Edit Purchase' if model.Id }}
		 <small class="pull-right">
		  	<a href="{{'purchases'|route_url}}" title="Back to Purchase listing!" class="btn btn-primary">
		  		<i class="icon-arrow-left icon-white"></i> Back
		  	</a>
		 </small></h1>
	</div>
	<div class="row-fluid">
		 <div id="statusMessage">
		 {% if errors or renderer.errorlist() or purchaseRenderer.errorlist() -%} 
		 	<div class="alert alert-error">
		 		<strong>Please correct the errors and submit again:</strong>
		 		{{ ('<ul><li>'+ errors + '</li></ul>') | safe if errors }}
		 		{{renderer.errorlist(name=None,class='')}}
		 		{{purchaseRenderer.errorlist(name=None,class='')}}
		 	</div>
		 {%- endif %}
		 </div>
		 </span>
		 <div class="clear"></div>
		 <div class="span7">
		 	<div class="span12">
		 		<h3>Purchase Details</h3>
		 		<form id="frmPurchase" action="{{'savepurchase'|route_url}}" method="post" class="well form-inline">
		 			<div class="control-group {{ 'error' if purchaseRenderer.is_error('PurchaseNo') }}" style="float:left;margin-right:10px;">
						{{purchaseRenderer.label('PurchaseNo','Bill No#',class='control-label')}}
						<div class="controls">
							{{purchaseRenderer.text('PurchaseNo',size=50,class='input-medium')}}
						</div>
					</div>
					<div class="control-group {{ 'error' if purchaseRenderer.is_error('SupplierId') }}" style="float:left;margin-right:10px;">
						{{purchaseRenderer.label('SupplierId','Supplier:',class='control-label')}}
						<div class="controls">
							{{purchaseRenderer.select('SupplierId',suppliers,prompt='Choose a supplier',class='input-medium')}}
						</div>
					</div>
					<div class="control-group {{ 'error' if purchaseRenderer.is_error('PurchaseDate') }}">
						{{purchaseRenderer.label('PurchaseDate','Purchase Date:',class='control-label')}}
						<div class="controls">
							{{purchaseRenderer.date('PurchaseDate',class='datetime input-medium')}}
						</div>
					</div>
					<table style="width:100%">
						<tbody>
						<tr>
							<td colspan="2">
								<h3>Total Items/Quantity: <span id="totalItems">{{model.TotalItems}}</span>/<span id="totalQuantity">{{model.TotalQuantity}}</span></h3>
							</td>
						</tr>
						<tr>
							<td style="text-align:left;width:50%">
								<h3>Paid Amount: Rs. <span id="paidAmount">{{model.GetPaidAmount()}}</span></h3>
							</td>
							<td style="text-align:right">
								<h3>Total Amount: Rs. <span id="totalAmount">{{model.GetTotalAmount()}}</span></h3>
							</td>
						</tbody>
					</table>
					<div class="form-actions">
						<input type="hidden" id="pid" name="pid" value="{{model.Id|d('',True)}}"/>
						<input type="submit" class="btn btn-primary" value="Save"/>
					</div>
				 </form>
		 	</div>
		 	<div class="clear"></div>
		 	<div class="span12">
		 		<h4>Purchase Line Items</h4>
		 		<div id="purchaseLineItemsDiv">
		 			<table class="table table-striped table-bordered table-condensed">
		 				<thead>
		 					<th></th>
		 					<th>Barcode</th>
		 					<th>Item Name</th>
		 					<th>MRP</th>
		 					<th>Tax</th>
		 					<th>Buy Price</th>
		 					<th>Discount</th>
		 					<th>Quantity</th>
		 					<th>Total</th>
		 				</thead>
		 				<tbody>
		 				{% for item in model.LineItems -%}
		 					<tr>
		 						<td><a data-total="{{item.BuyAmount}}" data-quantity="{{item.Quantity}}" class="delitem" href="/stock/deletepurchaselineitem?purchaseId={{model.Id}}&lineItemId={{item.Id}}" alt="Delete this item!"><i class="icon-trash"></i> </a></td>
		 						<td>{{item.Barcode}}</td>
		 						<td>{{item.Name}}</td>
		 						<td>{{item.MRP}}</td>
		 						<td>{{item.Tax}}</td>
		 						<td>{{item.BuyPrice}}</td>
		 						<td>{{item.Discount}}</td>
		 						<td>{{item.Quantity}}</td>
		 						<td>{{item.BuyAmount}}</td>
		 					</tr>
		 				{% endfor -%}
		 				</tbody>
		 			</table>
		 		</div>
		 	</div>
		 </div>
		 <div class="span4">
			<h3>Add/Edit Item</h3>
			<form id="frmLineItem" class="form-inline well">
				{% import 'shared/productform.jinja2' as productForm with context %}
				{{ productForm.render(renderer,True) }}
				<input type="hidden" name="ProductId" value=""/>
				<div class="form-actions">
					<input type="button" class="btn btn-primary" id="addlineItem" value="Add"/>
					<input type="reset" name="reset" class="btn" value="Reset"/>
				</div>
			</form>
		 </div>
	</div>
</section>      
{% endblock %}
{% block footerscript %}
<script>
	$.fn.serializeObject = function()
	{
		var o = {};
		var a = this.serializeArray();
		$.each(a, function() {
		    if (o[this.name] !== undefined) {
		        if (!o[this.name].push) {
		            o[this.name] = [o[this.name]];
		        }
		        o[this.name].push(this.value || '');
		    } else {
		        o[this.name] = this.value || '';
		    }
		});
		return o;
	};

	$(function(){
		$('input.datetime').datepicker({ dateFormat: 'dd-mm-yy' })
		
		$('form#frmLineItem input[type=text]').val('')
		
		$('#purchaseLineItemsDiv table tbody td a.delitem').on('click',function(){
			var url = $(this).attr('href')
			var quantity = parseFloat($(this).data('quantity'))
			var total = parseFloat($(this).data('total'))
			
			var $tr = $(this).parent().parent()
			$.get(url,null,function(data) {
				if(data && data.status == true){
					$tr.remove()
					var ti = parseInt($('#totalItems').text())
					var tq = parseFloat($('#totalQuantity').text())
					var ta = parseFloat($('#totalAmount').text())
					
					$('#totalAmount').text(ta-total)
					$('#totalItems').text(ti-1)
					$('#totalQuantity').text(tq-quantity)
					showMsg('info', data.message)
				}else{
					showMsg('error',data.message)
				}
			})
			return false
		})
		
		$('form#frmLineItem input[name=Barcode]').blur(function(e){
			var barcode = $(this).val()
			if(barcode == '' || barcode.length == 0) {
				e.preventDefault()
				return false
			}

			$.post('/stock/getproductsbybarcode',{barcode:barcode},function(data){
				if(data) {
					if(data.length) {
						data = data[0]
					}
					
					$('form#frmLineItem input[name=ProductId]').val(data.Id)
					$('form#frmLineItem input[name=Name]').val(data.Name)
					
					$('form#frmLineItem input[name=MRP]').val(data.MRP)
					$('form#frmLineItem input[name=MRP]').data('MRP',data.MRP)
					
					$('form#frmLineItem input[name=BuyPrice]').val(data.BuyPrice)
					$('form#frmLineItem input[name=BuyPrice]').data('BuyPrice',data.BuyPrice)
					
					$('form#frmLineItem input[name=SellPrice]').val(data.SellPrice)
					$('form#frmLineItem input[name=SellPrice]').data('SellPrice',data.SellPrice)
					
					$('form#frmLineItem input[name=Discount]').val(data.Discount)
					
					if(data.MfgDate)
						$('form#frmLineItem input[name=MfgDate]').val($.format.date(data.MfgDate,'dd-MM-yyyy'))
					if(data.ExpiryDate)
						$('form#frmLineItem input[name=ExpiryDate]').val($.format.date(data.ExpiryDate,'dd-MM-yyyy'))
						
					$('form#frmLineItem select[name=CategoryId]').val(data.CategoryId)
					$('form#frmLineItem select[name=TaxCategoryId]').val(data.TaxCategoryId)
				} else {
					// no item found in db so new its a new item
					$('form#frmLineItem input[type=text]').val('')
					$('form#frmLineItem input[name=Barcode]')[0].focus()
				}
			})
		})
		
		$('#addlineItem').click(function() {
			var purchaseId = $('input#pid').val()
			var supplierId = $('select[name=SupplierId]').val()
			if(!purchaseId) {
				showMsg('error', 'Should save the purchase before adding line items!')
				return
			}
			
			var jdata = $('form#frmLineItem').serializeObject()
			jdata.Tax = jdata.Tax || 0.0

			if (!(jdata.Name && jdata.Barcode && jdata.Quantity*1 > 0 
				&& jdata.MRP*1 > 0 && jdata.BuyPrice*1 < jdata.MRP*1
				&& jdata.SellPrice*1 > jdata.BuyPrice*1)) {
				showMsg('warn', 'Invalid data')
				return
			}
			
			var found = false
			$('#purchaseLineItemsDiv table tbody tr > td:nth-child(2)').each(function() {
				if($(this).text() == jdata.Barcode) {
					found = true
					return
				}
			})
			
			if(found) {
				var mrp = parseFloat($('form#frmLineItem input[name=MRP]').val())
				var pmrp = parseFloat($('form#frmLineItem input[name=MRP]').data('MRP'))
				
				var bp = parseFloat($('form#frmLineItem input[name=BuyPrice]').val())
				var pbp = parseFloat($('form#frmLineItem input[name=BuyPrice]').data('BuyPrice'))
				
				var sp = parseFloat($('form#frmLineItem input[name=SellPrice]').val())
				var psp = parseFloat($('form#frmLineItem input[name=SellPrice]').data('SellPrice'))
				
				if(mrp == pmrp && bp == pbp && sp == psp) {
					showMsg('warn', '<strong>"'+ jdata.Barcode +'"</strong> already added! If you want to update please delete and add again!')
					return
				}
				$('form#frmLineItem input[name=ProductId]').val('')
			}
			
			var postdata = 'pid=' + purchaseId + '&'
			postdata += 'SupplierId=' + supplierId + '&'
			postdata += $('form#frmLineItem').serialize()
			
			$.post('/stock/addpurchaselineitem',postdata,function(data){
				if(data && data.status == true) {
					//added success
					var id = data.id;
					var total = jdata.Quantity*jdata.BuyPrice;
					var tr = '<tr>';
					tr += '<td><a data-total="' + total + '"';
					tr += ' data-quantity="'+jdata.Quantity+'" class="delitem" href="/stock/deletepurchaselineitem?purchaseId=' + purchaseId;
					tr += '&lineItemId='+id +'" alt="Delete this item!"><i class="icon-trash"></i> </a></td>';
					tr += '<td>' + jdata.Barcode + '</td>';
					tr += '<td>' + jdata.Name + '</td>';
					tr += '<td>' + jdata.MRP + '</td>';
					tr += '<td>' + jdata.Tax + '</td>';
					tr += '<td>' + jdata.BuyPrice + '</td>';
					tr += '<td>' + jdata.Discount + '</td>';
					tr += '<td>' + jdata.Quantity + '</td>';
					tr += '<td>' + total + '</td>';
					tr += '</tr>';
					$('#purchaseLineItemsDiv table tbody').prepend(tr)
					
					var ti = parseInt($('#totalItems').text())
					var tq = parseFloat($('#totalQuantity').text())
					var ta = parseFloat($('#totalAmount').text())
					
					$('#totalAmount').text(ta+total)
					$('#totalItems').text(ti+1)
					$('#totalQuantity').text(tq+parseFloat(jdata.Quantity))
					$('form#frmLineItem input[type=text]').val('')
					$('form#frmLineItem input[name=Barcode]')[0].focus()
					showMsg('info', '<strong>"'+jdata.Barcode+'"</strong> added successfully!')
				}else{
					showMsg('error', data.message || 'Error while adding line item!')
				}
			},'json')
		});
		
		function hideMsg() {
			$('#statusMessage').fadeOut();
		}

		function showMsg(type, message, timeout) {
			var ediv = '<div class="alert ';
			if (type == "error") {
				ediv += 'alert-error';
			} else if (type == "info") {
				ediv += 'alert-info';
			} else if (type == "success") {
				ediv += 'alert-success';
			} else if (type == "warn") {
				ediv += 'alert-warning';
			} else {
				ediv += '';
			}
			ediv += ' fade in">';
			ediv += '<a class="close" data-dismiss="alert" href="#">&times;</a>';
			ediv += message;
			ediv += '</div>';
			$('#statusMessage').html(ediv);
			$('.alert', $('#statusMessage')).alert();

			if (timeout || timeout == undefined) {
				setTimeout(function () {
					$('.alert', $('#statusMessage')).alert('close');
				}, 10000);
			}
		}
	});
</script>
{% endblock %}
