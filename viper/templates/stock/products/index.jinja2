{% extends "templates/layout.jinja2" %}
{% block content %}
<section id="manage-products">
	<div class="page-header">
		<h1>Product Management
			 <small class="pull-right">
			  	<a href="{{'addproduct'|route_url}}" title="Add New Product to stock!" class="btn btn-primary">
			  		<i class="icon-plus icon-white"></i> Add Item
			  	</a>
			 </small>
		 </h1>
	</div> 	
	<div class="row-fluid">
		<div class="span12">
			<form id="searchForm" class="well form-inline" action="{{'products_xhr'|route_url}}">
				<label for="searchValue">Search Value: </label>
				<input type="text" name="searchValue" placeholder="Enter barcode or item name" id="searchValue" autofocus/>
				<input type="radio" name="searchField" value="Barcode" checked/> Barcode
				<input type="radio" name="searchField" value="Name"/> Name
				<input type="hidden" name="pageSize" value="20"/>
				<input type="submit" name="submit" value="Search" class="btn btn-success"/>
				<input type="reset" name="reset" value="Reset" class="btn"/>
			</form>
		</div>
	</div>
	<div id="statusMessage"></div>
	<div id="result">
    	{% include 'templates/stock/products/partialItemList.jinja2' with context %}
	</div>
</section>      
{% endblock %}
{% block footerscript %}
<style>
tr.alert-error td{
	background-color: #F2DEDE !important;
    border-color: #EED3D7;
    color: #B94A48;
}
</style>
<script>
	$(function(){
		$('form#searchForm').submit(function(){
			var postdata = $(this).serialize()
			$.post($(this).attr('action'),postdata,function(data){
				if(data){
					$('#result').html(data)
				}else{
					// search returns no value
					$('#result').html('<div class="alert alert-info">No items found!</div>')
				}
			})
			return false
		})
		
		$('table#prdTable tbody td.edit').live('click', function(){
			var w = $(this).width()-10
			$(this).editable(function(value,settings){
				var col = $(this).data('col')
				var tr = $(this).parent()
				var id = tr.data('id')
				var val = null
				
				value = value.trim()
				
				if(col != 'Name' && col != 'Barcode') {
					val = !isNaN(value) ? parseFloat(value) : null
					value = val
				}else{
					val = value
				}
				
				if(val) {
					var postdata = {id:id}
					if(col == 'SellPrice') {
						var mrp = parseFloat(tr.children('td[data-col=MRP]').text())
						var sellPrice = val
						var discount = (((mrp-sellPrice)*100)/mrp)
						postdata.SellPrice = sellPrice
						postdata.Discount = discount
						tr.children('td[data-col=Discount]').text(discount.toFixed(2))
					} else if(col == 'Discount') {
						var mrp = parseFloat(tr.children('td[data-col=MRP]').text())
						var discount = val
						var sellPrice = Math.round(mrp - (mrp * (discount/100.0)))
						postdata.Discount = discount
						postdata.SellPrice = sellPrice
						tr.children('td[data-col=SellPrice]').text(sellPrice)
					} else if(col == 'MRP') {
						var discount = parseFloat(tr.children('td[data-col=Discount]').text())
						var mrp = val
						var sellPrice = Math.round(mrp - (mrp * (discount/100.0)))
						postdata.MRP = mrp
						postdata.SellPrice = sellPrice
						tr.children('td[data-col=SellPrice]').text(sellPrice)
					}else{
						postdata[col] = val
					}

					$.post('/stock/updateproduct_xhr',postdata,function(data){
						if(data && data.status == true) {
							//update success
							showMsg('info','Updated successfully!')
						}else{
							// failed
							showMsg('error','Updated falied!')
						}
					},'json')
					return value
				}
			},
			{
				event: 'edit',
				height: 20,
				width: w,
				cssclass: 'inline-form',
			})
			$(this).trigger('edit')
		})
		
		$('table#prdTable a.pstatus').live('click',function(){
			var url = $(this).data('url')
			var st = $(this).data('status')
			var tr = $(this).closest('tr')
			var that = $(this)
			$.post(url,{status:!(st == 'True')},function(data){
				if(data && data.status == true) {
					if(st == 'True') {
						tr.addClass('alert')
						tr.addClass('alert-error')
						that.text('Mark Active')
						that.data('status','False')
					} else {
						tr.removeClass('alert')
						tr.removeClass('alert-error')
						that.text('Mark Return')
						that.data('status','True')
					}
				}
			})
			return true
		})
	});
	
	function hideMsg() {
		$('#statusMessage').slideUp('slow')
	}

	function showMsg(type, message, timeout) {
		var ediv = '<div class="alert ';
		if (type == "error") {
			ediv += 'alert-error';
		} else if (type == "info") {
			ediv += 'alert-info';
		} else if (type == "success") {
			ediv += 'alert-success';
		} else if (type == "warn") {
			ediv += 'alert-warning';
		} else {
			ediv += '';
		}
		ediv += ' fade in">';
		ediv += '<a class="close" data-dismiss="alert" href="#">&times;</a>';
		ediv += message;
		ediv += '</div>';
		$('#statusMessage').html(ediv);
		$('.alert', $('#statusMessage')).alert();

		if (timeout || timeout == undefined) {
			setTimeout(function () {
				$('.alert', $('#statusMessage')).alert('close');
			}, 10000);
		}
	}
</script>
{% endblock %}
